<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Udemy Web Development Ch31-2 Authentication-and-Security | Jeremy's Blog</title><meta name="author" content="Jeremy"><meta name="copyright" content="Jeremy"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Level 5 Cookies and Sessions去購物網站把商品加入購物車之後就離開頁面,在購物車裡面的商品資訊其實是儲存在cookies裡面 打開cookies設定,搜尋cookie,點擊Cookie和其他網站資料,點擊顯示所有Cookie 和網站資料 When Amazon adds those cookies to mu browser it also means that when">
<meta property="og:type" content="article">
<meta property="og:title" content="Udemy Web Development Ch31-2 Authentication-and-Security">
<meta property="og:url" content="https://razieldu.github.io/2022/04/23/Udemy-WebDevelopment-ch31-2-Authentication-and-Security/index.html">
<meta property="og:site_name" content="Jeremy&#39;s Blog">
<meta property="og:description" content="Level 5 Cookies and Sessions去購物網站把商品加入購物車之後就離開頁面,在購物車裡面的商品資訊其實是儲存在cookies裡面 打開cookies設定,搜尋cookie,點擊Cookie和其他網站資料,點擊顯示所有Cookie 和網站資料 When Amazon adds those cookies to mu browser it also means that when">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://github.com/Razieldu/BLOG-IMG/raw/main/%E9%83%A8%E8%90%BD%E6%A0%BC%E5%9C%96%E7%89%87.jpg">
<meta property="article:published_time" content="2022-04-23T07:22:19.000Z">
<meta property="article:modified_time" content="2022-04-28T04:53:05.277Z">
<meta property="article:author" content="Jeremy">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://github.com/Razieldu/BLOG-IMG/raw/main/%E9%83%A8%E8%90%BD%E6%A0%BC%E5%9C%96%E7%89%87.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://razieldu.github.io/2022/04/23/Udemy-WebDevelopment-ch31-2-Authentication-and-Security/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Udemy Web Development Ch31-2 Authentication-and-Security',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-04-28 12:53:05'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.1.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">90</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">8</div></a></div><hr/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://github.com/Razieldu/BLOG-IMG/raw/main/%E9%83%A8%E8%90%BD%E6%A0%BC%E5%9C%96%E7%89%87.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Jeremy's Blog</a></span><div id="menus"><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Udemy Web Development Ch31-2 Authentication-and-Security</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-04-23T07:22:19.000Z" title="Created 2022-04-23 15:22:19">2022-04-23</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-04-28T04:53:05.277Z" title="Updated 2022-04-28 12:53:05">2022-04-28</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Web-development/">Web development</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Udemy Web Development Ch31-2 Authentication-and-Security"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h3 id="Level-5-Cookies-and-Sessions"><a href="#Level-5-Cookies-and-Sessions" class="headerlink" title="Level 5 Cookies and Sessions"></a>Level 5 Cookies and Sessions</h3><p>去購物網站把商品加入購物車之後就離開頁面,在購物車裡面的商品資訊其實是儲存在cookies裡面</p>
<h3 id="打開cookies"><a href="#打開cookies" class="headerlink" title="打開cookies"></a>打開cookies</h3><p>設定,搜尋cookie,點擊Cookie和其他網站資料,點擊顯示所有Cookie 和網站資料</p>
<p>When Amazon adds those cookies to mu browser it also means that when I go and visit another website,the website will knows what items I want to buy on Amazon,and the website will remind me of that I want to by a switch on Amazon,this is essentially how retargeting adds work </p>
<p>使用者登入購物網站:瀏覽器向購物網站發出 get request,購物網站伺服器回應response(HTML,CSS,Javascript)</p>
<p>使用者在購物車加入商品:瀏覽器向購物網站發出 post request,購物網站伺服器產生cookie(儲存這個使用者購物車裡面的商品資料),當購物網站伺服器respond that post request,that cookie will be send along and the browser will be told to save the cookie,使用者離開網頁之後,cookie被儲存在瀏覽器裡面,當使用者再次登入該購物網站時,瀏覽器發出get request時,會連同cookie一起傳送給購物網站的伺服器,購物網站伺服器在respond的時候也會同時把相關物件增加到使用者的購物車裡面並連同網頁一起render給使用者的瀏覽器</p>
<h3 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h3><p>We are looking a cookie that are used to establish and maintain a session.</p>
<p>Session is a period of time when a browser interact with a server.So usually when you log into a website,that is when your session starts and that is when your cookie gets created,and inside that cookie you will have your user credentials(證書) that says this user is logged in and has been successfully authenticated.So that means as you continue to browse that website you will not be asked to login again when you try to access a page that requires authentication because they can try always check against that active cookie,because they can always check against that active cookie that you have on your browser and it maintains your authentication for this browsing session until the point when you log out which is when this sessions ends and the cookie that is related to the session get destroyed </p>
<h3 id="Using-Passport-js-to-Add-Cookies-and-Sessions"><a href="#Using-Passport-js-to-Add-Cookies-and-Sessions" class="headerlink" title="Using Passport.js to Add Cookies and Sessions"></a>Using Passport.js to Add Cookies and Sessions</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i passport passport-local passport-local-mongoose express-session //安裝四個套件</span><br></pre></td></tr></table></figure>


<p>app.js修改為</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">require(&quot;dotenv&quot;).config();</span><br><span class="line">const express = require(&quot;express&quot;);</span><br><span class="line">const bodyParser = require(&quot;body-parser&quot;);</span><br><span class="line">const ejs = require(&quot;ejs&quot;);</span><br><span class="line">const mongoose = require(&quot;mongoose&quot;);</span><br><span class="line"></span><br><span class="line">const session = require(&quot;express-session&quot;); //導入</span><br><span class="line">const passport = require(&quot;passport&quot;); //導入</span><br><span class="line">const passportLocalMongoose = require(&quot;passport-local-mongoose&quot;); //導入</span><br><span class="line"></span><br><span class="line">//We do not have to require passport-local,because it is gonna be one of the those dependencies that we will be needed by passport-local-mongoose</span><br><span class="line"></span><br><span class="line">const app = express();</span><br><span class="line"></span><br><span class="line">app.use(express.static(&quot;public&quot;));</span><br><span class="line">app.set(&quot;view engine&quot;,&quot;ejs&quot;);</span><br><span class="line">app.use(bodyParser.urlencoded(&#123;extended:true&#125;));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.use(session(&#123;</span><br><span class="line">  secret:process.env.SECRET_KEY,</span><br><span class="line">  resave:false,     ///true時,會話數據會被強行儲存</span><br><span class="line">  saveUninitialized:false  //true時，會強行保存未始化的會話</span><br><span class="line">&#125;));</span><br><span class="line">// We first tell our app to use the session package that we required up here and then we set it up with some initial configuration</span><br><span class="line"></span><br><span class="line">app.use(passport.initialize());</span><br><span class="line">app.use(passport.session());</span><br><span class="line">// we tell our app to use passport and to initialize the passport package and to also use passport for dealing with the sessions </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mongoose.connect(&quot;mongodb://localhost:27017/userDB&quot;,&#123;useNewUrlParser:true&#125;);</span><br><span class="line"></span><br><span class="line">const userSchema= new mongoose.Schema(&#123;  //這裡schema的形式一定要是這個</span><br><span class="line">email:String,</span><br><span class="line">password:String</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">userSchema.plugin(passportLocalMongoose); //注意位置,為每個用戶生成並儲存Hash,Salt值以及用戶名,最後導出模式 </span><br><span class="line"></span><br><span class="line">const User = new mongoose.model(&quot;User&quot;,userSchema);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">passport.use(User.createStrategy());  //在User模型設置本地策略</span><br><span class="line"></span><br><span class="line">passport.serializeUser(User.serializeUser()); </span><br><span class="line">//認證時對傳遞的用戶進行序列化,並在每一個後續請求中調用</span><br><span class="line">passport.deserializeUser(User.deserializeUser());</span><br><span class="line">//解除對用戶的序列化</span><br><span class="line"></span><br><span class="line">app.get(&quot;/&quot;,function(req,res)&#123;</span><br><span class="line"></span><br><span class="line">res.render(&quot;home&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(&quot;/login&quot;,function(req,res)&#123;</span><br><span class="line"></span><br><span class="line">res.render(&quot;login&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(&quot;/register&quot;,function(req,res)&#123;</span><br><span class="line"></span><br><span class="line">res.render(&quot;register&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(&quot;/secret&quot;,function(req,res)&#123;  //新增一個route,註解3</span><br><span class="line">   if(req.isAuthenticated())&#123;</span><br><span class="line">     res.render(&quot;/secrets&quot;)</span><br><span class="line">   &#125;else(</span><br><span class="line">     res.redirect(&quot;/login&quot;);</span><br><span class="line">   )</span><br><span class="line">  //確認是否有登入,沒有登入返回登入頁面</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.get(&quot;/logout&quot;,function(req,res)&#123;</span><br><span class="line">  req.logout();                     //req.logout  from passport package</span><br><span class="line">  res.redirect(&quot;/&quot;)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.post(&quot;/register&quot;,function(req,res)&#123;          //移除bcrypt的部分,並修改為</span><br><span class="line">User.register(&#123;username:req.body.username&#125;,req.body.password,function(err)&#123;</span><br><span class="line">  if(err)&#123;</span><br><span class="line">    console.log(err)</span><br><span class="line">    res.redirect(&quot;/register&quot;)</span><br><span class="line">  &#125;else&#123;</span><br><span class="line">    passport.authenticate(&quot;local&quot;)(req,res,function()&#123; //透過local策略來驗證用戶</span><br><span class="line">    res.redirect(&quot;/secrets&quot;) //註解2</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.post(&quot;/login&quot;,function(req,res)&#123;   //移除bcrypt的部分</span><br><span class="line"></span><br><span class="line">const user = new User(&#123;</span><br><span class="line"> username:req.body.username,</span><br><span class="line"> password:req.body.password</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">req.login(user,function(err)&#123;   //req.login from passport package</span><br><span class="line">  if(err)&#123;</span><br><span class="line">    console.log(err)</span><br><span class="line">  &#125;else&#123;</span><br><span class="line">    passport.authenticate(&quot;local&quot;)(req,res,function()&#123;</span><br><span class="line">    res.redirect(&quot;/secrets&quot;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(&quot;3000&quot;,function()&#123;</span><br><span class="line">    console.log(&quot;Server successfully run on port 3000&quot;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="app-post-x2F-register-註解"><a href="#app-post-x2F-register-註解" class="headerlink" title="app.post(&#x2F;register)註解"></a>app.post(&#x2F;register)註解</h3><p>Now we are first going to tap into the user model and we are going to call the method register on it ,and this method comes from the passport-local-mongoose package,and because od the package we can avoid creating our new user,saving our new user and interacting with mongoose directly. All of this things are handled by passport-local-mongoose package.</p>
<h3 id="註解2"><a href="#註解2" class="headerlink" title="註解2"></a>註解2</h3><p>Authenticate our user using passport,and the tpye of the authentication is local,this callback is only triggered if the authentication was successful,and we manage to successfully setup a cookie that saved their current logged in session,so will you have to check to see if they are logged in or not,so we can assume that the user end up in the callback function we can safely res.redirect them to the secret page</p>
<h3 id="Serialise-and-deserialise"><a href="#Serialise-and-deserialise" class="headerlink" title="Serialise and deserialise"></a>Serialise and deserialise</h3><p><strong>Serialise</strong>:what it does when we tell it to serialise our user it basically creates that cookie and stuffs the message namely our users identifications into the cookie. And then when we <strong>deserialise</strong> it basically allows the passport to destroy the cookie and discover the message inside which is who this user is.And all of their identification so that we can authentication them on our server </p>
<h3 id="註解3-把secret-route建構出來的原因"><a href="#註解3-把secret-route建構出來的原因" class="headerlink" title="註解3 把secret route建構出來的原因"></a>註解3 把secret route建構出來的原因</h3><p>Now notice that previously we never had a secrets route because we always relied on res.rendering the secret package either through register or through login,but in this case because we are authenticating our user and setting up a logged in session for them then even if they just go directly to the secret page,they should automatically be able to view it if they are in fact still log in,so that is why we need to create our secret route </p>
<h3 id="本專案cookie示意圖"><a href="#本專案cookie示意圖" class="headerlink" title="本專案cookie示意圖"></a>本專案cookie示意圖</h3><p><img src="https://github.com/Razieldu/BLOG-IMG/raw/main/%E7%B6%B2%E9%A0%81%E9%96%8B%E7%99%BC31-2%20cookie%20passport-session%E7%A4%BA%E6%84%8F%E5%9C%96.png" alt="網頁開發31-2 cookie passport-session示意圖.png"></p>
<h3 id="Passport-的三個核心部分"><a href="#Passport-的三個核心部分" class="headerlink" title="Passport 的三個核心部分"></a>Passport 的三個核心部分</h3><p>引用模塊，調用中間件 passport.initialize() 初始化 passport.js 的配置。如果需要持久化的登入<br>session，還需要調用中間件 passport.session() 。中間件的順序應為：express-session -&gt; passport.initialize -&gt; passport.session</p>
<p>配置 passport。需要配置的主要有兩個部分<br>身份認證策略（如驗證用戶名和密碼）</p>
<p>session。需要自行配置 passport.serializeUser() 和 passport.deserializeUser() （作用見下文）<br>指定需要使用 passport.authenticate() 的路由</p>
<h3 id="x2F-login-認證請求流程"><a href="#x2F-login-認證請求流程" class="headerlink" title="&#x2F;login 認證請求流程"></a>&#x2F;login 認證請求流程</h3><ol>
<li>用戶 POST 一個登入表單，導致中間件 passport.authenticate 的執行</li>
<li>調用相應的認證策略，這裡因為是用 username 和 password 進行登陸，所以使用 local 策略（由npm package passport-local 提供）</li>
<li>Passport 獲取 req.body.username 和 req.body.password ，用作驗證策略的參數（需要提前配置 body-parser ）</li>
<li>從數據庫取出相應的 user 對象，驗證密碼</li>
<li>如果驗證通過，passport 內部自動調用 req.login() ，用於建立登入session。</li>
<li>req.login() 會調用我們先前定義的 passport.serializeUser() ，該方法決定將 user 實例的哪些數據存入 session，一般選擇存 user.id。 passport.serializeUser() 將設置 req.session.passport.user &#x3D; {&#x2F;* serialized user object *&#x2F;}</li>
<li>然後將 user 實例掛載到 req.user 上</li>
<li>之後執行常規的 requestHandler</li>
</ol>
<h3 id="認證後的請求流程"><a href="#認證後的請求流程" class="headerlink" title="認證後的請求流程"></a>認證後的請求流程</h3><p>通過認證之後，發來的請求會經過下面的步驟：</p>
<ol>
<li>Express 加載 session 的數據，並將其掛載在 req上。</li>
<li>先前配置的 passport.initialize 中間件會發現 session 中有 passport.user 的數據。如果沒有則創建一個 req.passport.user &#x3D; {}</li>
<li>隨後觸發 passport.session 中間件，它本質上是一個名為 “session” 的認證策略，通過 session 存儲的 user data，根據先前定義的 passport.deserializeUser 方法，從數據庫中取出相應的 user 實例，並重新掛載在 ·req.user&#96; 上</li>
</ol>
<h3 id="需要注意的點"><a href="#需要注意的點" class="headerlink" title="需要注意的點"></a>需要注意的點</h3><p>從上面的流程可以知道，passport.authenticate(‘local’) 方法的核心是從 req.body 中獲取用戶名和密碼，並進行驗證。所以只能用在 POST 請求上<br>如果想判斷用戶是否登入，可以檢查 req.isAuthenticated()，而不是調用passport.authenticate() 方法<br>如果出現 session 有 passport.user 的數據，但是 req.user 為 undefined，passport.deserializeUser() 方法沒有被調用的情況：<br>請檢查 express-session, passport.initialize(), passport.session() 三個中間件的順序<br>開發階段一般沒有部署HTTPS，可以將 session 裡面 cookie.secure 設為 false，否則通過 HTTP 請求時 passport.deserializeUser() 會沒有被調用<br>如果 user data 沒有保存到 session 中，可能是 req.logIn() 沒有被調用。如果在調用 passport.authenticate(‘local’, custtomCallback) 時使用了自定義的回調函數，需要手動調用 req.logIn()</p>
<p>資料來源1:<a target="_blank" rel="noopener" href="https://zybuluo.com/FunC/note/1088513">https://zybuluo.com/FunC/note/1088513</a><br>資料來源2:<a target="_blank" rel="noopener" href="http://toon.io/understanding-passportjs-authentication-flow/">http://toon.io/understanding-passportjs-authentication-flow/</a></p>
<h3 id="Level-6-OAuth2-0-amp-How-to-Implement-Sign-In-with-Google"><a href="#Level-6-OAuth2-0-amp-How-to-Implement-Sign-In-with-Google" class="headerlink" title="Level 6 OAuth2.0 &amp; How to Implement Sign In with Google"></a>Level 6 OAuth2.0 &amp; How to Implement Sign In with Google</h3><p>OAuth:open authorisation,an open standard for token based authorization</p>
<p>Assuming that our app has contained serveral friends of this new user.<br>If our app use this method to make new user sign in,and a new user want to sign in our app,our app will make a GET request to Facebook asking them for this user’s friends on Facebook and Facebook would return with a POST request with that list of users and emails,and that data gets pass over to our server where we can compare it against our database of users and see whether we have any matching users who have the same email addresses,if this new user has three firends on our app,we will be able to automatically add them as a friend on our app.</p>
<p>By using of OAuth,we are able to access pieces of information on these third party website such as their friends and emails or their contacts on Gmail.</p>
<p>大公司的安全防護做的很足夠,我們的app要做到那樣的層級需要花很多的時間,我們可以把認證的工作交給他們,every time we log in our user,we simply ask them to login Facebook and Facebook will then authenticate them using their secure method and once that is doned,Facebook send us a message saying”This user is authenticated”.</p>
<ol>
<li><p>allow you to grant a granular level of access<br>means that when your user login with Facebook,you can request specific things from their Facebook account(profile,email)</p>
</li>
<li><p>Read&#x2F; Read + Write Access</p>
</li>
</ol>
<p>Read + Write access: 在user的Facebook帳號上使用我們的app,需要使用者同意並賦予我們的app權限</p>
<ol start="3">
<li>Revoke access<br>The third party you are using to authenticate your users should be able to revoke at any point on their website.If you are on authenticating with Facebook,the user should be able to go into their Facebook account and deauthorize the access that they granted to your website,and do not actually have to go onto your website where you may be less keen on giving up this access</li>
</ol>
<h3 id="1-Set-Up-Our-APP"><a href="#1-Set-Up-Our-APP" class="headerlink" title="1. Set Up Our APP"></a>1. Set Up Our APP</h3><p>We have to set up our app in their developer console and in return we get what we called an app id or a client id and our app is then the client which will make the request to Facebook to authenticate our user </p>
<h3 id="2-Redirect-to-Authenticate"><a href="#2-Redirect-to-Authenticate" class="headerlink" title="2. Redirect to Authenticate"></a>2. Redirect to Authenticate</h3><p>Now once you set up your app, the next step happens when the user tries to log on to your website. When the user want to sign up in our app,and they want to be authenticated, we give them a option to log in with Facebook.</p>
<h3 id="3-User-Log-In"><a href="#3-User-Log-In" class="headerlink" title="3. User Log In"></a>3. User Log In</h3><p>Once they click on that option then we will take them to the actual Facebook website so that they are seeing a familiar interface, a trustworthy interface and they will log into Facebook using their Facebook credentials. 沒有透過Facebook登入頁面直接索取他們Facebook帳號密碼也會讓用戶感覺非常不安全的事情  </p>
<h3 id="4-User-Grants-Permissions"><a href="#4-User-Grants-Permissions" class="headerlink" title="4. User Grants Permissions"></a>4. User Grants Permissions</h3><p>Once the user log in the third party,then they have to revier the permissions that our website is asking for(profile,email)</p>
<h3 id="5-Receive-Authentication-code"><a href="#5-Receive-Authentication-code" class="headerlink" title="5. Receive Authentication code"></a>5. Receive Authentication code</h3><p>now that they have granted the permission and they have successfully logged in on Facebook then ourr website will receive an authorization code from Facebook and this allows us to check to make sure that the user actually successfully sign on to Facebook. They had the right username and password.So,now we are able to autheticate them and log them on to our website. </p>
<h3 id="6-Exchange-Authcode-for-Access-Token"><a href="#6-Exchange-Authcode-for-Access-Token" class="headerlink" title="6. Exchange Authcode for Access Token"></a>6. Exchange Authcode for Access Token</h3><p>But if we want to go a step further, we can also exchange our authentication code for an access token, when we receive that access token from Facebook, we would save it in our database because this is the token that we can use if we want to request pieces of information subsequently. This access token is valid for a lot longer than the authentication token.</p>
<p>The <strong>authentication code</strong> or the OAth code is kind of like a ticket. A ticket that you are going to use once enter the cinema,but the <strong>access token</strong> is kind of more like a year pass and comes with benefits like backstage access where your get request piece of data from Facebook including their friend list or that username or their password whatever that may be they granted you to permission to access. So the OAuth code is <strong>what we need to authenticate user that they successfully managed to log in through Facebook</strong> and the access token is <strong>what we will use access pieces of information that are stored on that user’s account on these third party website(user’s email,friend list)</strong></p>
<h3 id="Use-Google-OAuth-2-0-In-Our-App"><a href="#Use-Google-OAuth-2-0-In-Our-App" class="headerlink" title="Use Google OAuth 2.0 In Our App"></a>Use Google OAuth 2.0 In Our App</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install passport-google-oauth20</span><br></pre></td></tr></table></figure>

<h3 id="前往Google-Cloud-Platform"><a href="#前往Google-Cloud-Platform" class="headerlink" title="前往Google Cloud Platform"></a>前往Google Cloud Platform</h3><p><a target="_blank" rel="noopener" href="https://console.cloud.google.com/apis">https://console.cloud.google.com/apis</a></p>
<h3 id="1-設定應用程式相關設定"><a href="#1-設定應用程式相關設定" class="headerlink" title="1.設定應用程式相關設定"></a>1.設定應用程式相關設定</h3><h3 id="OAuth同意畫面"><a href="#OAuth同意畫面" class="headerlink" title="OAuth同意畫面"></a>OAuth同意畫面</h3><ol>
<li>點擊建立專案</li>
<li>點擊憑證</li>
<li>點擊設定同意畫面</li>
<li>外部使用者</li>
</ol>
<h3 id="範圍"><a href="#範圍" class="headerlink" title="範圍"></a>範圍</h3><p>點擊新增或移除範圍<br>搜尋並選取:email,profile,openid</p>
<h3 id="2-憑證頁面"><a href="#2-憑證頁面" class="headerlink" title="2. 憑證頁面"></a>2. 憑證頁面</h3><ol>
<li><p>點擊建立憑證</p>
</li>
<li><p>點擊OAuth用戶端ID</p>
</li>
<li><p>類型選擇 網頁應用程式</p>
</li>
<li><p>已授權的 JavaScript 來源:<a target="_blank" rel="noopener" href="http://localhost:3000/">http://localhost:3000</a></p>
</li>
</ol>
<p>已授權的重新導向 URI:<a target="_blank" rel="noopener" href="http://localhost:3000/auth/google/secrets">http://localhost:3000/auth/google/secrets</a><br>This is a route that we are going to plan out on our server when Google has authenticated our user to return to so that we can then locally authenticate them and save the session and cookies and all of that </p>
<ol start="5">
<li>取得用戶端id 以及密碼並放置到.env檔案</li>
</ol>
<h3 id="設置Passport-google-oauth20"><a href="#設置Passport-google-oauth20" class="headerlink" title="設置Passport-google-oauth20"></a>設置Passport-google-oauth20</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install passport-google-oauth20</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm i mongoose-findorcreate </span><br><span class="line"></span><br><span class="line">//讓findOrCreate方程式運作起來,本來不是一個實際存在的方程式(功能是搜尋資料庫的使用者id,找不到的話進行建立,使用套件讓他實際能夠運作起來)</span><br></pre></td></tr></table></figure>

<p>app.js</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">require(&quot;dotenv&quot;).config();</span><br><span class="line">const express = require(&quot;express&quot;);</span><br><span class="line">const bodyParser = require(&quot;body-parser&quot;);</span><br><span class="line">const ejs = require(&quot;ejs&quot;);</span><br><span class="line">const mongoose = require(&quot;mongoose&quot;);</span><br><span class="line"></span><br><span class="line">const session = require(&quot;express-session&quot;);</span><br><span class="line">const passport = require(&quot;passport&quot;);</span><br><span class="line">const passportLocalMongoose = require(&quot;passport-local-mongoose&quot;);</span><br><span class="line">const GoogleStrategy = require(&quot;passport-google-oauth20&quot;).Strategy;</span><br><span class="line">const findOrCreate = require(&quot;mongoose-findorcreate&quot;)</span><br><span class="line"></span><br><span class="line">const app = express();</span><br><span class="line"></span><br><span class="line">app.use(express.static(&quot;public&quot;));</span><br><span class="line">app.set(&quot;view engine&quot;,&quot;ejs&quot;);</span><br><span class="line">app.use(bodyParser.urlencoded(&#123;extended:true&#125;));</span><br><span class="line"></span><br><span class="line">app.use(session(&#123;</span><br><span class="line">  secret:process.env.SECRET_KEY,</span><br><span class="line">  resave:false,</span><br><span class="line">  saveUninitialized:false</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line">app.use(passport.initialize());</span><br><span class="line">app.use(passport.session());</span><br><span class="line"></span><br><span class="line">mongoose.connect(&quot;mongodb://localhost:27017/userDB&quot;,&#123;useNewUrlParser:true&#125;);</span><br><span class="line"></span><br><span class="line">// mongoose.set(&quot;useCreateIndex&quot;,true);</span><br><span class="line"></span><br><span class="line">const userSchema= new mongoose.Schema(&#123;</span><br><span class="line">email:String,</span><br><span class="line">password:String</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">userSchema.plugin(passportLocalMongoose);</span><br><span class="line">userSchema.plugin(findOrCreate) //對應findOrCreate套件</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const User = new mongoose.model(&quot;User&quot;,userSchema);</span><br><span class="line"></span><br><span class="line">passport.use(User.createStrategy());</span><br><span class="line"></span><br><span class="line">passport.serializeUser(User.serializeUser());</span><br><span class="line">passport.deserializeUser(User.deserializeUser());</span><br><span class="line"></span><br><span class="line">passport.use(new GoogleStrategy(&#123;  //留意放置位子</span><br><span class="line">    clientID: process.env.CLIENT_ID,</span><br><span class="line">    clientSecret: process.env.CLIENT_SECRET,</span><br><span class="line">    callbackURL: &quot;http://localhost:3000/auth/google/secrets&quot;,</span><br><span class="line">    userProfileURL:&quot;https://www.googleapis.com/oauth2/v3/userinfo&quot; //避免google+式微(已經)</span><br><span class="line">  &#125;,</span><br><span class="line">  function(accessToken, refreshToken, profile, cb) &#123;</span><br><span class="line">    User.findOrCreate(&#123; googleId: profile.id &#125;, function (err, user) &#123; </span><br><span class="line">    //讓findOrCreate運作必須安裝 mongoose-findorcreate</span><br><span class="line">      return cb(err, user);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">));</span><br></pre></td></tr></table></figure>

<h3 id="問題點"><a href="#問題點" class="headerlink" title="問題點"></a>問題點</h3><p>打開伺服器,沒有地方可以連到google</p>
<p>login.ejs改為</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&lt;%- include(&#x27;partials/header&#x27;) %&gt;</span><br><span class="line"></span><br><span class="line">&lt;div class=&quot;container mt-5&quot;&gt;</span><br><span class="line">  &lt;h1&gt;Login&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">  &lt;div class=&quot;row&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;col-sm-8&quot;&gt;</span><br><span class="line">      &lt;div class=&quot;card&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;card-body&quot;&gt;</span><br><span class="line"></span><br><span class="line">          &lt;!-- Makes POST request to /login route --&gt;</span><br><span class="line">          &lt;form action=&quot;/login&quot; method=&quot;POST&quot;&gt;</span><br><span class="line">            &lt;div class=&quot;form-group&quot;&gt;</span><br><span class="line">              &lt;label for=&quot;email&quot;&gt;Email&lt;/label&gt;</span><br><span class="line">              &lt;input type=&quot;email&quot; class=&quot;form-control&quot; name=&quot;username&quot;&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div class=&quot;form-group&quot;&gt;</span><br><span class="line">              &lt;label for=&quot;password&quot;&gt;Password&lt;/label&gt;</span><br><span class="line">              &lt;input type=&quot;password&quot; class=&quot;form-control&quot; name=&quot;password&quot;&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;button type=&quot;submit&quot; class=&quot;btn btn-dark&quot;&gt;Login&lt;/button&gt;</span><br><span class="line">          &lt;/form&gt;</span><br><span class="line"></span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;div class=&quot;col-sm-4&quot;&gt; //新增</span><br><span class="line">      &lt;div class=&quot;card&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;card-body&quot;&gt;</span><br><span class="line">          &lt;a class=&quot;btn btn-block&quot; href=&quot;/auth/google&quot; role=&quot;button&quot;&gt;</span><br><span class="line">            &lt;i class=&quot;fab fa-google&quot;&gt;&lt;/i&gt;</span><br><span class="line">            Sign In with Google</span><br><span class="line">          &lt;/a&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;%- include(&#x27;partials/footer&#x27;) %&gt;</span><br></pre></td></tr></table></figure>

<p>register.ejs改為</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&lt;%- include(&#x27;partials/header&#x27;) %&gt;</span><br><span class="line">&lt;div class=&quot;container mt-5&quot;&gt;</span><br><span class="line">  &lt;h1&gt;Register&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">  &lt;div class=&quot;row&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;col-sm-8&quot;&gt;</span><br><span class="line">      &lt;div class=&quot;card&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;card-body&quot;&gt;</span><br><span class="line"></span><br><span class="line">          &lt;!-- Makes POST request to /register route --&gt;</span><br><span class="line">          &lt;form action=&quot;/register&quot; method=&quot;POST&quot;&gt;</span><br><span class="line">            &lt;div class=&quot;form-group&quot;&gt;</span><br><span class="line">              &lt;label for=&quot;email&quot;&gt;Email&lt;/label&gt;</span><br><span class="line">              &lt;input type=&quot;email&quot; class=&quot;form-control&quot; name=&quot;username&quot;&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div class=&quot;form-group&quot;&gt;</span><br><span class="line">              &lt;label for=&quot;password&quot;&gt;Password&lt;/label&gt;</span><br><span class="line">              &lt;input type=&quot;password&quot; class=&quot;form-control&quot; name=&quot;password&quot;&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;button type=&quot;submit&quot; class=&quot;btn btn-dark&quot;&gt;Register&lt;/button&gt;</span><br><span class="line">          &lt;/form&gt;</span><br><span class="line"></span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;div class=&quot;col-sm-4&quot;&gt;  //新增</span><br><span class="line">      &lt;div class=&quot;card social-block&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;card-body&quot;&gt;</span><br><span class="line">          &lt;a class=&quot;btn btn-block&quot; href=&quot;/auth/google&quot; role=&quot;button&quot;&gt;</span><br><span class="line">            &lt;i class=&quot;fab fa-google&quot;&gt;&lt;/i&gt;</span><br><span class="line">            Sign Up with Google</span><br><span class="line">          &lt;/a&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;%- include(&#x27;partials/header&#x27;) %&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>app.js</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line">//jshint esversion:6</span><br><span class="line">require(&quot;dotenv&quot;).config();</span><br><span class="line">const express = require(&quot;express&quot;);</span><br><span class="line">const bodyParser = require(&quot;body-parser&quot;);</span><br><span class="line">const ejs = require(&quot;ejs&quot;);</span><br><span class="line">const mongoose = require(&quot;mongoose&quot;);</span><br><span class="line"></span><br><span class="line">const session = require(&quot;express-session&quot;);</span><br><span class="line">const passport = require(&quot;passport&quot;);</span><br><span class="line">const passportLocalMongoose = require(&quot;passport-local-mongoose&quot;);</span><br><span class="line">const GoogleStrategy = require(&quot;passport-google-oauth20&quot;).Strategy;</span><br><span class="line">const findOrCreate = require(&quot;mongoose-findorcreate&quot;)</span><br><span class="line"></span><br><span class="line">const app = express();</span><br><span class="line"></span><br><span class="line">app.use(express.static(&quot;public&quot;));</span><br><span class="line">app.set(&quot;view engine&quot;,&quot;ejs&quot;);</span><br><span class="line">app.use(bodyParser.urlencoded(&#123;extended:true&#125;));</span><br><span class="line"></span><br><span class="line">app.use(session(&#123;</span><br><span class="line">  secret:process.env.SECRET_KEY,</span><br><span class="line">  resave:false,</span><br><span class="line">  saveUninitialized:false</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line">app.use(passport.initialize());</span><br><span class="line">app.use(passport.session());</span><br><span class="line"></span><br><span class="line">mongoose.connect(&quot;mongodb://localhost:27017/userDB&quot;,&#123;useNewUrlParser:true&#125;);</span><br><span class="line"></span><br><span class="line">// mongoose.set(&quot;useCreateIndex&quot;,true);</span><br><span class="line"></span><br><span class="line">const userSchema= new mongoose.Schema(&#123;</span><br><span class="line">email:String,</span><br><span class="line">password:String</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">userSchema.plugin(passportLocalMongoose);</span><br><span class="line">userSchema.plugin(findOrCreate) //對應findOrCreate套件</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const User = new mongoose.model(&quot;User&quot;,userSchema);</span><br><span class="line"></span><br><span class="line">passport.use(User.createStrategy());</span><br><span class="line"></span><br><span class="line">passport.serializeUser(User.serializeUser());</span><br><span class="line">passport.deserializeUser(User.deserializeUser());</span><br><span class="line"></span><br><span class="line">passport.use(new GoogleStrategy(&#123;</span><br><span class="line">    clientID: process.env.CLIENT_ID,</span><br><span class="line">    clientSecret: process.env.CLIENT_SECRET,</span><br><span class="line">    callbackURL: &quot;http://localhost:3000/auth/google/secrets&quot;,</span><br><span class="line">    userProfileURL:&quot;https://www.googleapis.com/oauth2/v3/userinfo&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  function(accessToken, refreshToken, profile, cb) &#123;</span><br><span class="line">    console.log(profile)</span><br><span class="line">    User.findOrCreate(&#123; googleId: profile.id &#125;, function (err, user) &#123; //讓findOrCreate運作必須安裝 mongoose-findorcreate</span><br><span class="line">      return cb(err, user);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.get(&quot;/&quot;,function(req,res)&#123;</span><br><span class="line"></span><br><span class="line">res.render(&quot;home&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(&quot;/auth/google&quot;,passport.authenticate(&quot;google&quot;, &#123; scope: [&quot;profile&quot;] &#125;)); //連到google登入gmail</span><br><span class="line"></span><br><span class="line">app.get(&quot;/auth/google/secrets&quot;,</span><br><span class="line">  passport.authenticate(&quot;google&quot;, &#123; failureRedirect: &#x27;/login&#x27; &#125;),</span><br><span class="line">  function(req, res) &#123;</span><br><span class="line">    // Successful authentication, redirect secrets page.</span><br><span class="line">    res.redirect(&#x27;/secrets&#x27;);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">app.get(&quot;/login&quot;,function(req,res)&#123;</span><br><span class="line"></span><br><span class="line">res.render(&quot;login&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(&quot;/register&quot;,function(req,res)&#123;</span><br><span class="line"></span><br><span class="line">res.render(&quot;register&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.get(&quot;/secrets&quot;,function(req,res)&#123;</span><br><span class="line">   if(req.isAuthenticated())&#123;</span><br><span class="line">     res.render(&quot;secrets&quot;)</span><br><span class="line">   &#125;else(</span><br><span class="line">     res.redirect(&quot;/login&quot;)</span><br><span class="line">   )</span><br><span class="line">  //確認是否有登入,沒有登入返回登入頁面</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.get(&quot;/logout&quot;,function(req,res)&#123;</span><br><span class="line">  req.logout();</span><br><span class="line">  res.redirect(&quot;/&quot;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.post(&quot;/register&quot;,function(req,res)&#123;</span><br><span class="line">User.register(&#123;username:req.body.username&#125;,req.body.password,function(err)&#123;</span><br><span class="line">  if(err)&#123;</span><br><span class="line">    console.log(err)</span><br><span class="line">    res.redirect(&quot;/register&quot;)</span><br><span class="line">  &#125;else&#123;</span><br><span class="line">    passport.authenticate(&quot;local&quot;)(req,res,function()&#123;</span><br><span class="line">    res.redirect(&quot;/secrets&quot;)</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.post(&quot;/login&quot;,function(req,res)&#123;</span><br><span class="line"></span><br><span class="line">const user = new User(&#123;</span><br><span class="line"> username:req.body.username,</span><br><span class="line"> password:req.body.password</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">req.login(user,function(err)&#123;</span><br><span class="line">  if(err)&#123;</span><br><span class="line">    console.log(err)</span><br><span class="line">  &#125;else&#123;</span><br><span class="line">    passport.authenticate(&quot;local&quot;)(req,res,function()&#123;</span><br><span class="line">    res.redirect(&quot;/secrets&quot;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(&quot;3000&quot;,function()&#123;</span><br><span class="line">    console.log(&quot;Server successfully run on port 3000&quot;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="出現問題"><a href="#出現問題" class="headerlink" title="出現問題"></a>出現問題</h3><p>在點擊sign up with google之後,並點擊gmail帳號,出現錯誤<br>顯示:Error: Failed to serialize user into session</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">passport.serializeUser(User.serializeUser());</span><br><span class="line">passport.deserializeUser(User.deserializeUser());</span><br><span class="line">///這是從passport-local-mongoose來的並應用在我們的local strategy 我們把它移除</span><br></pre></td></tr></table></figure>

<p>換上通用版本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">passport.serializeUser(function(user, cb) &#123;</span><br><span class="line">  process.nextTick(function() &#123;</span><br><span class="line">    cb(null, &#123; id: user.id, username: user.username, name: user.name &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">passport.deserializeUser(function(user, cb) &#123;</span><br><span class="line">  process.nextTick(function() &#123;</span><br><span class="line">    return cb(null, user);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>app.js</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line">//jshint esversion:6</span><br><span class="line">require(&quot;dotenv&quot;).config();</span><br><span class="line">const express = require(&quot;express&quot;);</span><br><span class="line">const bodyParser = require(&quot;body-parser&quot;);</span><br><span class="line">const ejs = require(&quot;ejs&quot;);</span><br><span class="line">const mongoose = require(&quot;mongoose&quot;);</span><br><span class="line"></span><br><span class="line">const session = require(&quot;express-session&quot;);</span><br><span class="line">const passport = require(&quot;passport&quot;);</span><br><span class="line">const passportLocalMongoose = require(&quot;passport-local-mongoose&quot;);</span><br><span class="line">const GoogleStrategy = require(&quot;passport-google-oauth20&quot;).Strategy;</span><br><span class="line">const findOrCreate = require(&quot;mongoose-findorcreate&quot;)</span><br><span class="line"></span><br><span class="line">const app = express();</span><br><span class="line"></span><br><span class="line">app.use(express.static(&quot;public&quot;));</span><br><span class="line">app.set(&quot;view engine&quot;,&quot;ejs&quot;);</span><br><span class="line">app.use(bodyParser.urlencoded(&#123;extended:true&#125;));</span><br><span class="line"></span><br><span class="line">app.use(session(&#123;</span><br><span class="line">  secret:process.env.SECRET_KEY,</span><br><span class="line">  resave:false,</span><br><span class="line">  saveUninitialized:false</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line">app.use(passport.initialize());</span><br><span class="line">app.use(passport.session());</span><br><span class="line"></span><br><span class="line">mongoose.connect(&quot;mongodb://localhost:27017/userDB&quot;,&#123;useNewUrlParser:true&#125;);</span><br><span class="line"></span><br><span class="line">// mongoose.set(&quot;useCreateIndex&quot;,true);</span><br><span class="line"></span><br><span class="line">const userSchema= new mongoose.Schema(&#123;</span><br><span class="line">email:String,</span><br><span class="line">password:String</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">userSchema.plugin(passportLocalMongoose);</span><br><span class="line">userSchema.plugin(findOrCreate) //對應findOrCreate套件</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const User = new mongoose.model(&quot;User&quot;,userSchema);</span><br><span class="line"></span><br><span class="line">passport.use(User.createStrategy());</span><br><span class="line"></span><br><span class="line">passport.serializeUser(function(user, cb) &#123;</span><br><span class="line">  process.nextTick(function() &#123;</span><br><span class="line">    cb(null, &#123; id: user.id, username: user.username, name: user.name &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">passport.deserializeUser(function(user, cb) &#123;</span><br><span class="line">  process.nextTick(function() &#123;</span><br><span class="line">    return cb(null, user);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">passport.use(new GoogleStrategy(&#123;</span><br><span class="line">    clientID: process.env.CLIENT_ID,</span><br><span class="line">    clientSecret: process.env.CLIENT_SECRET,</span><br><span class="line">    callbackURL: &quot;http://localhost:3000/auth/google/secrets&quot;,</span><br><span class="line">    userProfileURL:&quot;https://www.googleapis.com/oauth2/v3/userinfo&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  function(accessToken, refreshToken, profile, cb) &#123;</span><br><span class="line">    console.log(profile)</span><br><span class="line">    User.findOrCreate(&#123; googleId: profile.id &#125;, function (err, user) &#123; //讓findOrCreate運作必須安裝 mongoose-findorcreate</span><br><span class="line">      return cb(err, user);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.get(&quot;/&quot;,function(req,res)&#123;</span><br><span class="line"></span><br><span class="line">res.render(&quot;home&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(&quot;/auth/google&quot;,passport.authenticate(&quot;google&quot;, &#123; scope: [&quot;profile&quot;] &#125;)); //連到google登入gmail</span><br><span class="line"></span><br><span class="line">app.get(&quot;/auth/google/secrets&quot;,</span><br><span class="line">  passport.authenticate(&quot;google&quot;, &#123; failureRedirect: &#x27;/login&#x27; &#125;),</span><br><span class="line">  function(req, res) &#123;</span><br><span class="line">    // Successful authentication, redirect secrets page.</span><br><span class="line">    res.redirect(&#x27;/secrets&#x27;);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">app.get(&quot;/login&quot;,function(req,res)&#123;</span><br><span class="line"></span><br><span class="line">res.render(&quot;login&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(&quot;/register&quot;,function(req,res)&#123;</span><br><span class="line"></span><br><span class="line">res.render(&quot;register&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.get(&quot;/secrets&quot;,function(req,res)&#123;</span><br><span class="line">   if(req.isAuthenticated())&#123;</span><br><span class="line">     res.render(&quot;secrets&quot;)</span><br><span class="line">   &#125;else(</span><br><span class="line">     res.redirect(&quot;/login&quot;)</span><br><span class="line">   )</span><br><span class="line">  //確認是否有登入,沒有登入返回登入頁面</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.get(&quot;/logout&quot;,function(req,res)&#123;</span><br><span class="line">  req.logout();</span><br><span class="line">  res.redirect(&quot;/&quot;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.post(&quot;/register&quot;,function(req,res)&#123;</span><br><span class="line">User.register(&#123;username:req.body.username&#125;,req.body.password,function(err)&#123;</span><br><span class="line">  if(err)&#123;</span><br><span class="line">    console.log(err)</span><br><span class="line">    res.redirect(&quot;/register&quot;)</span><br><span class="line">  &#125;else&#123;</span><br><span class="line">    passport.authenticate(&quot;local&quot;)(req,res,function()&#123;</span><br><span class="line">    res.redirect(&quot;/secrets&quot;)</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.post(&quot;/login&quot;,function(req,res)&#123;</span><br><span class="line"></span><br><span class="line">const user = new User(&#123;</span><br><span class="line"> username:req.body.username,</span><br><span class="line"> password:req.body.password</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">req.login(user,function(err)&#123;</span><br><span class="line">  if(err)&#123;</span><br><span class="line">    console.log(err)</span><br><span class="line">  &#125;else&#123;</span><br><span class="line">    passport.authenticate(&quot;local&quot;)(req,res,function()&#123;</span><br><span class="line">    res.redirect(&quot;/secrets&quot;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(&quot;3000&quot;,function()&#123;</span><br><span class="line">    console.log(&quot;Server successfully run on port 3000&quot;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="問題"><a href="#問題" class="headerlink" title="問題"></a>問題</h3><p>資料庫裡面使用google註冊的用戶資料只有mongoDB產生的id</p>
<h3 id="解決"><a href="#解決" class="headerlink" title="解決"></a>解決</h3><p>在userSchemay增加一個googleid</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">const userSchema= new mongoose.Schema(&#123;</span><br><span class="line">email:String,</span><br><span class="line">password:String,</span><br><span class="line">googleId:String</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>


<p>app.js</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line">//jshint esversion:6</span><br><span class="line">require(&quot;dotenv&quot;).config();</span><br><span class="line">const express = require(&quot;express&quot;);</span><br><span class="line">const bodyParser = require(&quot;body-parser&quot;);</span><br><span class="line">const ejs = require(&quot;ejs&quot;);</span><br><span class="line">const mongoose = require(&quot;mongoose&quot;);</span><br><span class="line"></span><br><span class="line">const session = require(&quot;express-session&quot;);</span><br><span class="line">const passport = require(&quot;passport&quot;);</span><br><span class="line">const passportLocalMongoose = require(&quot;passport-local-mongoose&quot;);</span><br><span class="line">const GoogleStrategy = require(&quot;passport-google-oauth20&quot;).Strategy;</span><br><span class="line">const findOrCreate = require(&quot;mongoose-findorcreate&quot;)</span><br><span class="line"></span><br><span class="line">const app = express();</span><br><span class="line"></span><br><span class="line">app.use(express.static(&quot;public&quot;));</span><br><span class="line">app.set(&quot;view engine&quot;,&quot;ejs&quot;);</span><br><span class="line">app.use(bodyParser.urlencoded(&#123;extended:true&#125;));</span><br><span class="line"></span><br><span class="line">app.use(session(&#123;</span><br><span class="line">  secret:process.env.SECRET_KEY,</span><br><span class="line">  resave:false,</span><br><span class="line">  saveUninitialized:false</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line">app.use(passport.initialize());</span><br><span class="line">app.use(passport.session());</span><br><span class="line"></span><br><span class="line">mongoose.connect(&quot;mongodb://localhost:27017/userDB&quot;,&#123;useNewUrlParser:true&#125;);</span><br><span class="line"></span><br><span class="line">// mongoose.set(&quot;useCreateIndex&quot;,true);</span><br><span class="line"></span><br><span class="line">const userSchema= new mongoose.Schema(&#123;</span><br><span class="line">email:String,</span><br><span class="line">password:String,</span><br><span class="line">googleId:String</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">userSchema.plugin(passportLocalMongoose);</span><br><span class="line">userSchema.plugin(findOrCreate) //對應findOrCreate套件</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const User = new mongoose.model(&quot;User&quot;,userSchema);</span><br><span class="line"></span><br><span class="line">passport.use(User.createStrategy());</span><br><span class="line"></span><br><span class="line">passport.serializeUser(function(user, cb) &#123;</span><br><span class="line">  process.nextTick(function() &#123;</span><br><span class="line">    cb(null, &#123; id: user.id, username: user.username, name: user.name &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">passport.deserializeUser(function(user, cb) &#123;</span><br><span class="line">  process.nextTick(function() &#123;</span><br><span class="line">    return cb(null, user);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">passport.use(new GoogleStrategy(&#123;</span><br><span class="line">    clientID: process.env.CLIENT_ID,</span><br><span class="line">    clientSecret: process.env.CLIENT_SECRET,</span><br><span class="line">    callbackURL: &quot;http://localhost:3000/auth/google/secrets&quot;,</span><br><span class="line">    userProfileURL:&quot;https://www.googleapis.com/oauth2/v3/userinfo&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  function(accessToken, refreshToken, profile, cb) &#123;</span><br><span class="line">    console.log(profile)</span><br><span class="line">    User.findOrCreate(&#123; googleId: profile.id &#125;, function (err, user) &#123; //讓findOrCreate運作必須安裝 mongoose-findorcreate</span><br><span class="line">      return cb(err, user);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.get(&quot;/&quot;,function(req,res)&#123;</span><br><span class="line"></span><br><span class="line">res.render(&quot;home&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(&quot;/auth/google&quot;,passport.authenticate(&quot;google&quot;, &#123; scope: [&quot;profile&quot;] &#125;)); //連到google登入gmail</span><br><span class="line"></span><br><span class="line">app.get(&quot;/auth/google/secrets&quot;,</span><br><span class="line">  passport.authenticate(&quot;google&quot;, &#123; failureRedirect: &#x27;/login&#x27; &#125;),</span><br><span class="line">  function(req, res) &#123;</span><br><span class="line">    // Successful authentication, redirect secrets page.</span><br><span class="line">    res.redirect(&#x27;/secrets&#x27;);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">app.get(&quot;/login&quot;,function(req,res)&#123;</span><br><span class="line"></span><br><span class="line">res.render(&quot;login&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(&quot;/register&quot;,function(req,res)&#123;</span><br><span class="line"></span><br><span class="line">res.render(&quot;register&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.get(&quot;/secrets&quot;,function(req,res)&#123;</span><br><span class="line">   if(req.isAuthenticated())&#123;</span><br><span class="line">     res.render(&quot;secrets&quot;)</span><br><span class="line">   &#125;else(</span><br><span class="line">     res.redirect(&quot;/login&quot;)</span><br><span class="line">   )</span><br><span class="line">  //確認是否有登入,沒有登入返回登入頁面</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.get(&quot;/logout&quot;,function(req,res)&#123;</span><br><span class="line">  req.logout();</span><br><span class="line">  res.redirect(&quot;/&quot;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.post(&quot;/register&quot;,function(req,res)&#123;</span><br><span class="line">User.register(&#123;username:req.body.username&#125;,req.body.password,function(err)&#123;</span><br><span class="line">  if(err)&#123;</span><br><span class="line">    console.log(err)</span><br><span class="line">    res.redirect(&quot;/register&quot;)</span><br><span class="line">  &#125;else&#123;</span><br><span class="line">    passport.authenticate(&quot;local&quot;)(req,res,function()&#123;</span><br><span class="line">    res.redirect(&quot;/secrets&quot;)</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.post(&quot;/login&quot;,function(req,res)&#123;</span><br><span class="line"></span><br><span class="line">const user = new User(&#123;</span><br><span class="line"> username:req.body.username,</span><br><span class="line"> password:req.body.password</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">req.login(user,function(err)&#123;</span><br><span class="line">  if(err)&#123;</span><br><span class="line">    console.log(err)</span><br><span class="line">  &#125;else&#123;</span><br><span class="line">    passport.authenticate(&quot;local&quot;)(req,res,function()&#123;</span><br><span class="line">    res.redirect(&quot;/secrets&quot;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(&quot;3000&quot;,function()&#123;</span><br><span class="line">    console.log(&quot;Server successfully run on port 3000&quot;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="美化一下我們的google按鈕"><a href="#美化一下我們的google按鈕" class="headerlink" title="美化一下我們的google按鈕"></a>美化一下我們的google按鈕</h3><p>Social Buttons for Bootstrap:<a target="_blank" rel="noopener" href="https://lipis.github.io/bootstrap-social/">https://lipis.github.io/bootstrap-social/</a> </p>
<ol>
<li>點擊下載,打開資料夾,找到bootstrap-social.css,複製到我們的css資料夾</li>
<li>link bootstrap-social.css</li>
</ol>
<p><strong>header.ejs</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot; dir=&quot;ltr&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">  &lt;title&gt;Secrets&lt;/title&gt;</span><br><span class="line">  &lt;link rel=&quot;stylesheet&quot; href=&quot;https://use.fontawesome.com/releases/v5.6.3/css/all.css&quot; integrity=&quot;sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/&quot; crossorigin=&quot;anonymous&quot;&gt;</span><br><span class="line">  &lt;link rel=&quot;stylesheet&quot; href=&quot;https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css&quot; integrity=&quot;sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS&quot; crossorigin=&quot;anonymous&quot;&gt;</span><br><span class="line">  &lt;link rel=&quot;stylesheet&quot; href=&quot;css/bootstrap-social.css&quot;&gt;</span><br><span class="line">  &lt;link rel=&quot;stylesheet&quot; href=&quot;css/styles.css&quot;&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br></pre></td></tr></table></figure>

<p>register.ejs 修改下列程式碼為</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a class=&quot;btn btn-block btn-social btn-google&quot; href=&quot;/auth/google&quot; role=&quot;button&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>login.ejs 修改下列程式碼為</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a class=&quot;btn btn-block btn-social btn-google&quot; href=&quot;/auth/google&quot; role=&quot;button&quot;&gt;</span><br></pre></td></tr></table></figure>

<h3 id="完整我們的app"><a href="#完整我們的app" class="headerlink" title="完整我們的app"></a>完整我們的app</h3><p>submit頁面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">app.get(&quot;/submit&quot;,function(req,res)&#123;</span><br><span class="line">  if(req.isAuthenticated())&#123;</span><br><span class="line">    res.render(&quot;submit&quot;)</span><br><span class="line">  &#125;else(</span><br><span class="line">    res.redirect(&quot;/login&quot;)</span><br><span class="line">  )</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>新增一個欄位secret</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">const userSchema= new mongoose.Schema(&#123;</span><br><span class="line">email:String,</span><br><span class="line">password:String,</span><br><span class="line">googleId:String,</span><br><span class="line">secret:String</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>app.post(&#x2F;submit)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">app.post(&quot;/submit&quot;,function(req,res)&#123;</span><br><span class="line">  const submittedSecret =  req.body.secret</span><br><span class="line">  console.log(req.user.id)</span><br><span class="line">  User.findById(req.user.id,function(err,foundUser)&#123;</span><br><span class="line">    if(err)&#123;</span><br><span class="line">      console.log(err)</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">      if(foundUser)&#123;</span><br><span class="line">        foundUser.secret = submittedSecret;</span><br><span class="line">        foundUser.save(function()&#123;</span><br><span class="line">          res.redirect(&quot;/secrets&quot;)</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>
<p>&#x2F;&#x2F;passport save the users details because when we initiate a new login session,it will save the user details into a request variable,so we use console.log to check.<br>我們可以使用mongoose的物件id來進行身分確認,並儲存用戶提交的secret內容在對應id  </p>
<p>每個進入我們網頁的使用者都要可以看到secret page 的 secret,所以secret 頁面不再是登入才能看到,<br>確認是否登入的部分移除,目標是把所有被輸入並儲存在資料庫的secrets都呈現在screts頁面上</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">app.get(&quot;/secrets&quot;,function(req,res)&#123;</span><br><span class="line">User.find(&#123;&quot;secret&quot;:&#123;$ne:null&#125;&#125;,function(err,foundUsers)&#123;</span><br><span class="line">  if(err)&#123;</span><br><span class="line">   console.log(err)</span><br><span class="line">  &#125;else&#123;</span><br><span class="line">   res.render(&quot;secrets&quot;,&#123; usersWithSecrets:foundUsers&#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line">  //確認是否有登入,沒有登入返回登入頁面</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>secrets.ejs</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;%- include(&#x27;partials/header&#x27;) %&gt;</span><br><span class="line"></span><br><span class="line">&lt;div class=&quot;jumbotron text-center&quot;&gt;</span><br><span class="line">  &lt;div class=&quot;container&quot;&gt;</span><br><span class="line">    &lt;i class=&quot;fas fa-key fa-6x&quot;&gt;&lt;/i&gt;</span><br><span class="line">    &lt;h1 class=&quot;display-3&quot;&gt;You&#x27;ve Discovered My Secret!&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">    &lt;%&gt;usersWithSecrets.forEach(function(user)&#123;&lt;%&gt;</span><br><span class="line">    &lt;p class=&quot;secret-text&quot;&gt;&lt;%=user.secret%&gt;&lt;/p&gt;</span><br><span class="line">    &lt;%&#125;);%&gt;</span><br><span class="line"></span><br><span class="line">    &lt;hr&gt;</span><br><span class="line">    &lt;a class=&quot;btn btn-light btn-lg&quot; href=&quot;/logout&quot; role=&quot;button&quot;&gt;Log Out&lt;/a&gt;</span><br><span class="line">    &lt;a class=&quot;btn btn-dark btn-lg&quot; href=&quot;/submit&quot; role=&quot;button&quot;&gt;Submit a Secret&lt;/a&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;%- include(&#x27;partials/footer&#x27;) %&gt;</span><br></pre></td></tr></table></figure>




</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="https://razieldu.github.io">Jeremy</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://razieldu.github.io/2022/04/23/Udemy-WebDevelopment-ch31-2-Authentication-and-Security/">https://razieldu.github.io/2022/04/23/Udemy-WebDevelopment-ch31-2-Authentication-and-Security/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://github.com/Razieldu/BLOG-IMG/raw/main/%E9%83%A8%E8%90%BD%E6%A0%BC%E5%9C%96%E7%89%87.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/gh/overtrue/share.js@master/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/04/28/Udemy-React-TheCompleteGuide-ch1-Getting-Started/"><img class="prev-cover" src="https://github.com/Razieldu/BLOG-IMG/raw/main/%E9%83%A8%E8%90%BD%E6%A0%BC%E5%9C%96%E7%89%87.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Udemy-React-TheCompleteGuide-ch1-Getting-Started</div></div></a></div><div class="next-post pull-right"><a href="/2022/04/21/Udemy-WebDevelopment-ch31-1-Authentication-and-Security/"><img class="next-cover" src="https://github.com/Razieldu/BLOG-IMG/raw/main/%E9%83%A8%E8%90%BD%E6%A0%BC%E5%9C%96%E7%89%87.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Udemy Web Development Ch31-1 Authentication-and-Security</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Jeremy</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">90</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">8</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Razieldu"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Level-5-Cookies-and-Sessions"><span class="toc-number">1.</span> <span class="toc-text">Level 5 Cookies and Sessions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E9%96%8Bcookies"><span class="toc-number">2.</span> <span class="toc-text">打開cookies</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Session"><span class="toc-number">3.</span> <span class="toc-text">Session</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Using-Passport-js-to-Add-Cookies-and-Sessions"><span class="toc-number">4.</span> <span class="toc-text">Using Passport.js to Add Cookies and Sessions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#app-post-x2F-register-%E8%A8%BB%E8%A7%A3"><span class="toc-number">5.</span> <span class="toc-text">app.post(&#x2F;register)註解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A8%BB%E8%A7%A32"><span class="toc-number">6.</span> <span class="toc-text">註解2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Serialise-and-deserialise"><span class="toc-number">7.</span> <span class="toc-text">Serialise and deserialise</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A8%BB%E8%A7%A33-%E6%8A%8Asecret-route%E5%BB%BA%E6%A7%8B%E5%87%BA%E4%BE%86%E7%9A%84%E5%8E%9F%E5%9B%A0"><span class="toc-number">8.</span> <span class="toc-text">註解3 把secret route建構出來的原因</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AC%E5%B0%88%E6%A1%88cookie%E7%A4%BA%E6%84%8F%E5%9C%96"><span class="toc-number">9.</span> <span class="toc-text">本專案cookie示意圖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Passport-%E7%9A%84%E4%B8%89%E5%80%8B%E6%A0%B8%E5%BF%83%E9%83%A8%E5%88%86"><span class="toc-number">10.</span> <span class="toc-text">Passport 的三個核心部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#x2F-login-%E8%AA%8D%E8%AD%89%E8%AB%8B%E6%B1%82%E6%B5%81%E7%A8%8B"><span class="toc-number">11.</span> <span class="toc-text">&#x2F;login 認證請求流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AA%8D%E8%AD%89%E5%BE%8C%E7%9A%84%E8%AB%8B%E6%B1%82%E6%B5%81%E7%A8%8B"><span class="toc-number">12.</span> <span class="toc-text">認證後的請求流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E9%BB%9E"><span class="toc-number">13.</span> <span class="toc-text">需要注意的點</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Level-6-OAuth2-0-amp-How-to-Implement-Sign-In-with-Google"><span class="toc-number">14.</span> <span class="toc-text">Level 6 OAuth2.0 &amp; How to Implement Sign In with Google</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Set-Up-Our-APP"><span class="toc-number">15.</span> <span class="toc-text">1. Set Up Our APP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Redirect-to-Authenticate"><span class="toc-number">16.</span> <span class="toc-text">2. Redirect to Authenticate</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-User-Log-In"><span class="toc-number">17.</span> <span class="toc-text">3. User Log In</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-User-Grants-Permissions"><span class="toc-number">18.</span> <span class="toc-text">4. User Grants Permissions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-Receive-Authentication-code"><span class="toc-number">19.</span> <span class="toc-text">5. Receive Authentication code</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-Exchange-Authcode-for-Access-Token"><span class="toc-number">20.</span> <span class="toc-text">6. Exchange Authcode for Access Token</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Use-Google-OAuth-2-0-In-Our-App"><span class="toc-number">21.</span> <span class="toc-text">Use Google OAuth 2.0 In Our App</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E5%BE%80Google-Cloud-Platform"><span class="toc-number">22.</span> <span class="toc-text">前往Google Cloud Platform</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E8%A8%AD%E5%AE%9A%E6%87%89%E7%94%A8%E7%A8%8B%E5%BC%8F%E7%9B%B8%E9%97%9C%E8%A8%AD%E5%AE%9A"><span class="toc-number">23.</span> <span class="toc-text">1.設定應用程式相關設定</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OAuth%E5%90%8C%E6%84%8F%E7%95%AB%E9%9D%A2"><span class="toc-number">24.</span> <span class="toc-text">OAuth同意畫面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AF%84%E5%9C%8D"><span class="toc-number">25.</span> <span class="toc-text">範圍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%86%91%E8%AD%89%E9%A0%81%E9%9D%A2"><span class="toc-number">26.</span> <span class="toc-text">2. 憑證頁面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A8%AD%E7%BD%AEPassport-google-oauth20"><span class="toc-number">27.</span> <span class="toc-text">設置Passport-google-oauth20</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%95%8F%E9%A1%8C%E9%BB%9E"><span class="toc-number">28.</span> <span class="toc-text">問題點</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%BA%E7%8F%BE%E5%95%8F%E9%A1%8C"><span class="toc-number">29.</span> <span class="toc-text">出現問題</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%95%8F%E9%A1%8C"><span class="toc-number">30.</span> <span class="toc-text">問題</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B1%BA"><span class="toc-number">31.</span> <span class="toc-text">解決</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BE%8E%E5%8C%96%E4%B8%80%E4%B8%8B%E6%88%91%E5%80%91%E7%9A%84google%E6%8C%89%E9%88%95"><span class="toc-number">32.</span> <span class="toc-text">美化一下我們的google按鈕</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E6%88%91%E5%80%91%E7%9A%84app"><span class="toc-number">33.</span> <span class="toc-text">完整我們的app</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/09/30/LeeCode-Plus-One/" title="LeeCode-Plus-One"><img src="https://github.com/Razieldu/BLOG-IMG/raw/main/%E9%83%A8%E8%90%BD%E6%A0%BC%E5%9C%96%E7%89%87.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="LeeCode-Plus-One"/></a><div class="content"><a class="title" href="/2022/09/30/LeeCode-Plus-One/" title="LeeCode-Plus-One">LeeCode-Plus-One</a><time datetime="2022-09-30T12:34:06.000Z" title="Created 2022-09-30 20:34:06">2022-09-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/09/30/Udemy-React-TheCompleteGuide-ch26-Testing-React-App/" title="Udemy-React-TheCompleteGuide ch26 Testing React App  "><img src="https://github.com/Razieldu/BLOG-IMG/raw/main/%E9%83%A8%E8%90%BD%E6%A0%BC%E5%9C%96%E7%89%87.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Udemy-React-TheCompleteGuide ch26 Testing React App  "/></a><div class="content"><a class="title" href="/2022/09/30/Udemy-React-TheCompleteGuide-ch26-Testing-React-App/" title="Udemy-React-TheCompleteGuide ch26 Testing React App  ">Udemy-React-TheCompleteGuide ch26 Testing React App  </a><time datetime="2022-09-30T05:53:55.000Z" title="Created 2022-09-30 13:53:55">2022-09-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/09/22/LeeCode-Search-Insert-Position/" title="LeeCode-Search-Insert-Position"><img src="https://github.com/Razieldu/BLOG-IMG/raw/main/%E9%83%A8%E8%90%BD%E6%A0%BC%E5%9C%96%E7%89%87.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="LeeCode-Search-Insert-Position"/></a><div class="content"><a class="title" href="/2022/09/22/LeeCode-Search-Insert-Position/" title="LeeCode-Search-Insert-Position">LeeCode-Search-Insert-Position</a><time datetime="2022-09-22T13:00:06.000Z" title="Created 2022-09-22 21:00:06">2022-09-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/09/22/%E8%B3%BC%E7%89%A9%E8%BB%8A%E9%82%8F%E8%BC%AF-Redux-VS-ReduxToolkit/" title="購物車邏輯 Redux VS ReduxToolkit"><img src="https://github.com/Razieldu/BLOG-IMG/raw/main/%E9%83%A8%E8%90%BD%E6%A0%BC%E5%9C%96%E7%89%87.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="購物車邏輯 Redux VS ReduxToolkit"/></a><div class="content"><a class="title" href="/2022/09/22/%E8%B3%BC%E7%89%A9%E8%BB%8A%E9%82%8F%E8%BC%AF-Redux-VS-ReduxToolkit/" title="購物車邏輯 Redux VS ReduxToolkit">購物車邏輯 Redux VS ReduxToolkit</a><time datetime="2022-09-22T07:59:13.000Z" title="Created 2022-09-22 15:59:13">2022-09-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/09/21/Typescript/" title="Typescript"><img src="https://github.com/Razieldu/BLOG-IMG/raw/main/%E9%83%A8%E8%90%BD%E6%A0%BC%E5%9C%96%E7%89%87.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Typescript"/></a><div class="content"><a class="title" href="/2022/09/21/Typescript/" title="Typescript">Typescript</a><time datetime="2022-09-21T06:18:06.000Z" title="Created 2022-09-21 14:18:06">2022-09-21</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By Jeremy</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>